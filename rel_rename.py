from pprint import pprint
# state = {'?ele-JCommTable.R0C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544661867957-2', 'id': 'JCommTable.R0C0', 'value': '2', 'contentEditable': False, 'below': '?ele-JCommTable.R1C0'}, '?ele-JCommTable.R1C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544661867957-2', 'id': 'JCommTable.R1C0', 'value': '3', 'contentEditable': False, 'above': '?ele-JCommTable.R0C0'}, '?ele-JCommTable3.R0C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544662032496-5', 'id': 'JCommTable3.R0C0', 'value': '4', 'contentEditable': False, 'below': '?ele-JCommTable.R1C0'}, '?ele-JCommTable3.R1C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544662032496-5', 'id': 'JCommTable3.R1C0', 'value': '3', 'contentEditable': False, 'above': '?ele-JCommTable.R0C0'}, '?ele-JCommTable4.R0C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544662076475-6', 'id': 'JCommTable4.R0C0', 'value': '', 'contentEditable': True, 'below': '?ele-JCommTable.R1C0'}, '?ele-JCommTable4.R1C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544662076475-6', 'id': 'JCommTable4.R1C0', 'value': '', 'contentEditable': True, 'below': '?ele-JCommTable.R1C0', 'above': '?ele-JCommTable.R0C0'}, '?ele-JCommTable5.R0C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544662076487-8', 'id': 'JCommTable5.R0C0', 'value': '', 'contentEditable': True, 'below': '?ele-JCommTable.R1C0'}, '?ele-JCommTable5.R1C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544662076487-8', 'id': 'JCommTable5.R1C0', 'value': '', 'contentEditable': True, 'above': '?ele-JCommTable.R0C0'}, '?ele-JCommTable7.R0C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544662248828-11', 'id': 'JCommTable7.R0C0', 'value': '+', 'contentEditable': False, 'below': '?ele-JCommTable.R1C0'}, '?ele-JCommTable2.R0C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544662283254-14', 'id': 'JCommTable2.R0C0', 'value': '+', 'contentEditable': False, 'below': '?ele-JCommTable.R1C0'}, '?ele-JCommTable6.R0C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544662568348-15', 'id': 'JCommTable6.R0C0', 'value': '', 'contentEditable': True, 'below': '?ele-JCommTable.R1C0'}, '?ele-JCommTable6.R1C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1544662568348-15', 'id': 'JCommTable6.R1C0', 'value': '', 'contentEditable': True, 'above': '?ele-JCommTable.R0C0'}, '?ele-ctatdiv68': {'type': 'CTATTextField', 'offsetParent': 'background-initial', 'id': 'ctatdiv68', 'below': '?ele-ctatdiv87', 'above': '?ele-ctatdiv74'}, '?ele-ctatdiv74': {'type': 'CTATTextField', 'offsetParent': 'background-initial', 'id': 'ctatdiv74', 'below': '?ele-ctatdiv68'}, '?ele-done': {'type': 'CTATDoneButton', 'offsetParent': 'background-initial', 'id': 'done', 'below': '?ele-hint', 'above': '?ele-ctatdiv69', 'to_left': '?ele-ctatdiv87'}, '?ele-hint': {'type': 'CTATHintButton', 'offsetParent': 'background-initial', 'id': 'hint', 'above': '?ele-done', 'to_left': '?ele-ctatdiv87'}, '?ele-ctatdiv87': {'type': 'CTATHintWindow', 'offsetParent': 'background-initial', 'id': 'ctatdiv87', 'above': '?ele-ctatdiv68', 'to_right': '?ele-done'}, '?ele-ctatdiv69': {'type': 'CTATTextField', 'offsetParent': 'background-initial', 'id': 'ctatdiv69', 'below': '?ele-ctatdiv68', 'above': '?ele-ctatdiv74'}, '?ele-JCommTable8.R0C0': {'type': 'CTATTable--cell', 'offsetParent': 'silex-id-1547530347773-0', 'id': 'JCommTable8.R0C0', 'value': '', 'contentEditable': True, 'below': '?ele-JCommTable.R1C0'}}
state = {'?ele-ctatdiv68': {'type': 'CTATTextField', 'offsetParent': 'background-initial', 'id': 'ctatdiv68', 'below': '?ele-out4', 'above': '?ele-inpA3', 'to_right': '?ele-inpB3'}, '?ele-inpA3': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'inpA3', 'value': '7', 'contentEditable': False, 'below': '?ele-ctatdiv68', 'above': '?ele-carry2', 'to_right': '?ele-inpA2'}, '?ele-inpA2': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'inpA2', 'value': '7', 'contentEditable': False, 'below': '?ele-ctatdiv68', 'above': '?ele-carry1', 'to_right': '?ele-inpA1', 'to_left': '?ele-inpA3'}, '?ele-inpA1': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'inpA1', 'value': '7', 'contentEditable': False, 'below': '?ele-ctatdiv68', 'to_left': '?ele-inpA3'}, '?ele-inpB3': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'inpB3', 'value': '7', 'contentEditable': False, 'below': '?ele-ctatdiv68', 'above': '?ele-inpA3', 'to_right': '?ele-inpB2', 'to_left': '?ele-ctatdiv68'}, '?ele-inpB2': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'inpB2', 'value': '7', 'contentEditable': False, 'below': '?ele-ctatdiv68', 'above': '?ele-inpA2', 'to_right': '?ele-inpB1', 'to_left': '?ele-ctatdiv68'}, '?ele-inpB1': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'inpB1', 'value': '7', 'contentEditable': False, 'below': '?ele-ctatdiv68', 'above': '?ele-inpA1', 'to_left': '?ele-ctatdiv68'}, '?ele-out4': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'out4', 'value': '', 'contentEditable': True, 'below': '?ele-ctatdiv54', 'above': '?ele-ctatdiv68', 'to_right': '?ele-out3'}, '?ele-out3': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'out3', 'value': '', 'contentEditable': True, 'below': '?ele-ctatdiv54', 'above': '?ele-ctatdiv68', 'to_right': '?ele-out2', 'to_left': '?ele-out4'}, '?ele-out2': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'out2', 'value': '', 'contentEditable': True, 'below': '?ele-ctatdiv54', 'above': '?ele-ctatdiv68', 'to_right': '?ele-out1', 'to_left': '?ele-out4'}, '?ele-out1': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'out1', 'value': '', 'contentEditable': True, 'below': '?ele-hint', 'above': '?ele-ctatdiv68', 'to_left': '?ele-out4'}, '?ele-ctatdiv51': {'type': 'CTATTextField', 'offsetParent': 'background-initial', 'id': 'ctatdiv51', 'below': '?ele-ctatdiv68', 'above': '?ele-carry3', 'to_right': '?ele-inpB3', 'to_left': '?ele-ctatdiv68'}, '?ele-carry2': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'carry2', 'value': '', 'contentEditable': True, 'below': '?ele-ctatdiv68', 'to_right': '?ele-carry1', 'to_left': '?ele-carry3'}, '?ele-carry1': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'carry1', 'value': '', 'contentEditable': True, 'below': '?ele-ctatdiv68', 'to_left': '?ele-carry2'}, '?ele-hint': {'type': 'CTATHintButton', 'offsetParent': 'background-initial', 'id': 'hint', 'below': '?ele-done', 'above': '?ele-ctatdiv68', 'to_left': '?ele-ctatdiv54'}, '?ele-done': {'type': 'CTATDoneButton', 'offsetParent': 'background-initial', 'id': 'done', 'above': '?ele-ctatdiv68', 'to_left': '?ele-ctatdiv54'}, '?ele-ctatdiv54': {'type': 'CTATHintWindow', 'offsetParent': 'background-initial', 'id': 'ctatdiv54', 'above': '?ele-ctatdiv68', 'to_right': '?ele-hint'}, '?ele-carry3': {'type': 'CTATTextInput', 'offsetParent': 'background-initial', 'id': 'carry3', 'value': '', 'contentEditable': True, 'below': '?ele-ctatdiv68', 'to_right': '?ele-carry2'}}
dir_map = {"to_left": "l", "to_right": "r", "above": "a", "below":"b", "offsetParent":"p"}
dirs = list(dir_map.keys())




def _relative_rename_recursive(state,center,center_name="sel",mapping=None):
	if(mapping is None):
		mapping = {center:center_name}
	center_obj = state[center]

	stack = []
	for d in dirs:
		ele = center_obj.get(d,None)
		if(ele is None or ele in mapping or ele not in state):
			continue
		mapping[ele] = center_name + "." + dir_map[d]
		stack.append(ele)

	for ele in stack:
		_relative_rename_recursive(state,ele,mapping[ele],mapping)

	return mapping

def variablize_state_relative(state,where_match,center_name="sel"):
	center = where_match[0]
	mapping = _relative_rename_recursive(state,center,center_name=center_name)
	floating_elems = [x for x in state.keys() if x not in mapping]

	for f_ele in floating_elems:
		for d in dirs:
			ele = state[f_ele].get(d,None)
			if(ele is not None and ele in mapping):
				float_name = "float." + dir_map[d] + "==" + mapping[ele]
				if(float_name not in mapping):
					mapping[f_ele] = float_name
					break 

	floating_elems = [x for x in state.keys() if x not in mapping]
	assert len(floating_elems) == 0, "Floating elements %s \
		   could not be assigned relative to the rest of the state" % \
		   floating_elems.keys()
	
	new_state = {}
	for key,vals in state.items():
		new_vals = {}
		for k,v in vals.items():
			new_vals[k] = mapping.get(v,v)

		new_state[mapping[key]] = new_vals

	return new_state

	# print()


new_state = variablize_state_relative(state,["?ele-out1"])
pprint(new_state)


# out = rename_recursive(state,"?ele-out1")
# print()
# pprint(state)

# print(len(state.keys()),len(out.keys()), {x for x in state.keys() if x not in out})